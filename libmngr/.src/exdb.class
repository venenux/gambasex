' Gambas class file

''' clase de manejo de conexciones a base de datos indicadas, tiene dos conexciones, una en memoria y otra remota de db central, TODO: pool de conexciones de n conexciones

Export

Inherits Collection

'' abstracion de la configuracion principal
Private $appconfig As Settings = Null
'' abstracion de la configuracion basedatos
Private $appconfdb As Settings = Null

Private $conexciones As Connection[]  '' variable interna de conneciones

'' prepara una instancia del pool de las conexciones a las bases de datos, el error si alguno ocurre esta en el ultimo elemento
Public Sub _new()
    
    Dim config As New Excfg(gb.IgnoreCase, exapp.exebasepath)
    
End

'' constructor del pool de las conexciones indicadas en configuracion
Private Sub preparaConexiones() As Boolean
    
    ' Dim dbusr, dbnam, dbip, dbpor, dbpas As String = ""
    ' Dim apploc, appusr, appmac As String = ""
    ' Dim $configurados As New Collection
    ' 
    ' If Not IsNull($objconfs) Then
    '     $configurados = $objconfs.configuracion             ' instancio y leo la configuracion, tomo valores de db (nota TODO: pass en md5)
    ' Endif
    ' apploc = $configurados["cod_localidad"]
    ' appusr = $configurados["cod_localusua"]
    ' appmac = exnet.getImdef()
    ' dbip = $configurados["cnxmysqldbip"]
    ' dbusr = $configurados["cnxmysqldbusr"]
    ' dbnam = $configurados["cnxmysqldbnam"]
    ' dbpas = $configurados["cnxmysqldbpas"]  ' TODO: pass leer en md5 y decodificar aqui
    ' If indexnumberscons = 1 Then
    ' 
    ' Else
    '     Try $conexdbsql.Close()              ' Cierra la conexion con try para no error si esta cerrada
    '     $conexdbsql = New Connection
    '     $conexdbsql.Type = "mysql"       ' Define el tipo de Conexion
    '     $conexdbsql.Host = dbip   ' Nombre del Servidor
    '     $conexdbsql.Login = dbusr       ' Usuario para la coenxion
    '     $conexdbsql.Port = "3306"        ' Puerto usado para la conexion, usualmente: 3306
    '     $conexdbsql.Name = dbnam      ' Nombre de la base de datos a usar
    '     $conexdbsql.Password = dbpas ' Clave de Usuario
    '     Try $conexdbsql.Open()               ' Abrimos la conexion
    '     conninpoolavailable = True
    '     If Error Then
    '         $conexdbsql = Null
    '         conninpoolavailable = False ' si algun error colocan en null el elmento
    '     Endif
    '     If Not conninmemmavailable Then     ' es dificil que la db en memoria cambie o se desconecte
    '         preparaConexionram()             ' por ende es seguro confiar que si esta presente es la misma de siempre
    '     Endif
    ' Endif
    ' $conexciones.Add($conexdbsql, 1)
    ' 
End

'' instancia db memoria conexcion hacia '$conexdbram' \ es sqlite en memoria, manejese con cuidado
Private Sub preparaConexionram()
    
'     If conninmemmavailable And Not IsNull($conexdbram) Then          ' verificar si la conexcion activa y valida
'         If $conexdbram.Opened And $conexdbram.Name = "" Then      ' si es valida verificar activa y de memoria
'             $conexciones.Add($conexdbram, 0)                       ' si todo bien, reinsertar en el pool como primera
'             conninmemmavailable = True              ' reemplazo le index 0 por la activa seguro y devuelvo esta conexcion
'         Else
'             Goto REINICIARDBMEM
'         Endif
'     Else
' REINICIARDBMEM:
'         $conexdbram = New Connection
'         $conexdbram.Type = "sqlite3"             'esto siempre va en minusculas: always must be lowercase
'         $conexdbram.Name = Null
'         Try $conexdbram.Open
'         If Error Then
'             $conexdbram = Null
'             conninmemmavailable = False
'         Endif
'         $conexciones.Add($conexdbram, 0)
'         conninmemmavailable = True
'     Endif
'     
End


